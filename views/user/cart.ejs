<%-include('../partials/header.ejs') %>

<style>
  .cart-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }
  .cart-header {
    background-color: #f7f8fa;
    padding: 30px 0;
    margin-bottom: 40px;
    border-radius: 8px;
  }
  .cart-header h1 {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 10px;
    color: #333;
  }
  .breadcrumb {
    display: flex;
    align-items: center;
  }
  .breadcrumb a {
    color: #666;
    text-decoration: none;
    transition: color 0.3s;
  }
  .breadcrumb a:hover {
    color: #4d82ea;
  }
  .breadcrumb span {
    margin: 0 10px;
  }
  .cart-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }
  .cart-table th {
    background-color: #f7f8fa;
    padding: 15px;
    text-align: left;
    font-size: 14px;
    color: #666;
    font-weight: 600;
  }
  .cart-table td {
    padding: 20px 15px;
    border-bottom: 1px solid #f0f0f0;
    vertical-align: middle;
  }
  .cart-table tr:last-child td {
    border-bottom: none;
  }
  .product-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
  }
  .product-details h5 {
    font-size: 16px;
    margin-bottom: 5px;
  }
  .product-details p {
    font-size: 13px;
    color: #888;
    margin: 0;
  }
  .product-price {
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }
  .price-per-item {
    font-size: 13px;
    color: #888;
  }
  .quantity-control {
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    width: fit-content;
    margin: 0 auto;
  }
  .quantity-btn {
    background: #f7f8fa;
    border: none;
    width: 30px;
    height: 30px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
  }
  .quantity-btn:hover {
    background: #e0e0e0;
  }
  .quantity-input {
    width: 40px;
    text-align: center;
    border: none;
    border-left: 1px solid #e0e0e0;
    border-right: 1px solid #e0e0e0;
    height: 30px;
    font-size: 14px;
  }
  .remove-btn {
    background: transparent;
    border: none;
    color: #ff5c5c;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.3s;
  }
  .remove-btn:hover {
    color: #ff3333;
  }
  .remove-btn i {
    margin-right: 5px;
  }
  .cart-summary {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    padding: 25px;
  }
  .summary-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 20px;
    color: #333;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
  }
  .summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    font-size: 15px;
  }
  .summary-label {
    color: #666;
  }
  .summary-value {
    font-weight: 600;
    color: #333;
  }
  .discount-value {
    /* color: #ff5c5c; */
    color: #40a100e3;
  }
  .shipping-label {
    display: flex;
    flex-direction: column;
  }
  .shipping-link {
    font-size: 13px;
    color: #4d82ea;
    margin-top: 3px;
    cursor: pointer;
    text-decoration: none;
  }
  .total-row {
    display: flex;
    justify-content: space-between;
    margin: 20px 0;
    padding-top: 15px;
    border-top: 1px solid #f0f0f0;
  }
  .total-label {
    font-size: 16px;
    font-weight: 600;
    color: #333;
  }
  .total-value {
    font-size: 18px;
    font-weight: 700;
    color: #4d82ea;
  }
  .checkout-btn {
    display: block;
    width: 100%;
    padding: 15px;
    background-color: #4d82ea;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
    text-align: center;
    text-decoration: none;
    margin-bottom: 15px;
  }
  .checkout-btn:hover {
    background-color: #3a6ed0;
  }
  .continue-shopping {
    display: block;
    text-align: center;
    color: #4d82ea;
    font-size: 15px;
    text-decoration: none;
    transition: color 0.3s;
  }
  .continue-shopping:hover {
    color: #3a6ed0;
  }
  .empty-cart-message {
    text-align: center;
    padding: 50px 0;
    font-size: 18px;
    color: #666;
  }
  .coupon-container {
    display: flex;
    margin-top: 20px;
  }
  .coupon-input {
    flex: 1;
    padding: 10px 15px;
    border: 1px solid #e0e0e0;
    border-radius: 4px 0 0 4px;
    font-size: 14px;
  }
  .coupon-btn {
    background-color: #4caf50;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 0 4px 4px 0;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: background-color 0.3s;
  }
  .coupon-btn:hover {
    background-color: #45a049;
  }
  a{
    text-decoration: none;
  }

  @media (max-width: 992px) {
    .cart-table th:nth-child(1),
    .cart-table td:nth-child(1) {
      display: none;
    }
  }

  @media (max-width: 768px) {
    .cart-container {
      padding: 10px;
    }
    .cart-table th,
    .cart-table td {
      padding: 10px;
    }
    .cart-summary {
      margin-top: 30px;
    }
  }
  /* Breadcrumb */
  .shop-breadcrumb {
    padding: 20px 0;
    background-color: #f6f6f6;
    margin-bottom: 40px;
  }

  .breadcrumb-content {
    display: flex;
    flex-direction: column;
  }

  .breadcrumb-content h2 {
    font-size: 30px;
    font-weight: 600;
    margin-bottom: 10px;
    color: #333;
  }

  .breadcrumb-content ol {
    display: flex;
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: 14px;
  }

  .breadcrumb-content li + li:before {
    content: "/";
    padding: 0 8px;
    color: #777;
  }

  .breadcrumb-content a {
    color: #555;
    text-decoration: none;
    transition: color 0.3s;
  }

  .breadcrumb-content a:hover {
    color: #000000;
  }
</style>

<div class="header-bottom header-sticky d-none d-lg-block d-xl-block mb-0">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <!-- Begin Header Bottom Menu Area -->
        <div class="hb-menu">
          <nav>
            <ul>
              <li class="dropdown-holder">
                <a href="/">Home</a>
              </li>
              <li class="megamenu-holder active">
                <a href="/products">Shop</a>
              </li>
              <li><a href="/about">About Us</a></li>
              <li><a href="/contact">Contact</a></li>
            </ul>
          </nav>
        </div>
        <!-- Header Bottom Menu Area End Here -->
      </div>
    </div>
  </div>
</div>
<!-- Sticky Header Area End -->

<!-- Begin Breadcrumb Area -->
<div class="shop-breadcrumb">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="breadcrumb-content">
          <ol>
            <li><a href="/">Home</a></li>
            <li>Cart</li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Breadcrumb Area End -->
  <div class="container mb-5">
    <div class="row">
      <div class="col-lg-8 col-md-12">
        <div class="table-responsive">
          <table class="cart-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Details</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (cartItems && cartItems.length > 0) { %> <%
              cartItems.forEach(function(item) { %>
              <tr>
                <td>
                  <img
                    src="uploads/product-images/<%= item.product.productImage[0] %>"
                    alt="<%=
                  item.product.productName %>"
                    class="product-image"
                  />
                </td>
                <td class="product-details">
                  <h5>
                    <a href="/products/<%= item.product._id %>"
                      ><%= item.product.productName %></a
                    >
                  </h5>
                  <p>Category: <%= item.product.category.name %></p>
                  <p>Brand: <%= item.product.brand %></p>
                </td>
                <td class="product-price">
                  ₹<span id="subTotal<%= item.product._id %>"
                    ><%= item.totalPrice.toLocaleString('en-IN') %></span
                  >
                  <div class="price-per-item">
                    ₹<span id="price<%= item.product._id %>"
                      ><%= item.product.salePrice.toLocaleString('en-IN') %></span
                    >
                    / item
                  </div>
                </td>
                <td>
                  <div class="quantity-control">
                    <button
                      class="quantity-btn"
                      onclick="changeQuantity('<%= item.product._id %>', 'decrease', '<%= item.product.quantity %>')"
                    >
                      -
                    </button>
                    <input
                      class="quantity-input"
                      id="cartProductQuantity<%= item.product._id %>"
                      value="<%= item.quantity %>"
                      type="text"
                      readonly
                    />
                    <button
                      class="quantity-btn"
                      onclick="changeQuantity('<%= item.product._id %>', 'increase', '<%= item.product.quantity %>')"
                    >
                      +
                    </button>
                  </div>
                </td>
                <td>
                  <button
                    class="remove-btn"
                    onclick="confirmRemove('<%= item.product._id %>')"
                  >
                    <i class="fi-rs-trash"></i> Remove
                  </button>
                </td>
              </tr>
              <% }); %> <% } else { %>
              <tr>
                <td colspan="5" class="empty-cart-message">
                  <p>Your shopping cart is empty</p>
                  <a href="/products" class="continue-shopping"
                    >Start shopping now</a
                  >
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <div class="col-lg-4 col-md-12">
        <div class="cart-summary">
          <h3 class="summary-title">Order Summary</h3>

          <div class="summary-row">
            <span class="summary-label">Total</span>
            <span class="summary-value">₹ <%= totalproductPrice.toLocaleString('en-IN') %></span>
          </div>
          

          
          
            <div class="summary-row">
              <span class="summary-label">Discount ( <%= Number((offerdiscount/totalproductPrice)*100).toLocaleString() %>% ) </span>

              <span class="discount-value">(-) ₹<%= Number(offerdiscount).toLocaleString('en-IN', { minimumFractionDigits: 2 }) %></span>

              
            </div>
            

          <div class="summary-row">
            <div class="shipping-label">
              <span class="summary-label">Shipping</span>
              <a href="#" class="shipping-link" onclick="viewShippingCharge()"
                >View shipping policies</a
              >
            </div>
            <span class="summary-value">Free</span>
          </div>

          <div class="total-row">
            <span class="total-label">Grand Total</span>
            <% Number(grandTotal) %>
            <span class="total-value" id="total">₹ <%= grandTotal.toFixed("en-IN") %></span>
          </div>

          <% if (cartItems && cartItems.length > 0) { %>
          <a href="/checkout" class="checkout-btn">Proceed to Checkout</a>
          <a href="/products" class="continue-shopping">Continue Shopping</a>


                       
          <% } else { %>
          <a href="/products" class="checkout-btn">Start Shopping</a>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function changeQuantity(productId, action, maxStock) {
    const quantityElement = document.getElementById(
      `cartProductQuantity${productId}`
    );
    let currentQuantity = parseInt(quantityElement.value);

    if (action === "increase") {
      if (currentQuantity >= 5) {
        Swal.fire("Error", "Maximum 5 quantity per user", "error");
        return;
      }
      if (currentQuantity >= maxStock) {
        Swal.fire("Error", "Stock limit exceeded", "error");
        return;
      }
      currentQuantity++;
    } else if (action === "decrease") {
      if (currentQuantity > 1) {
        currentQuantity--;
      } else {
        confirmRemove(productId);
        return;
      }
    }


    $.ajax({
      url: "/changeQuantity",
      method: "PATCH",
      data: { productId: productId, action: action },
      success: (response) => {
        if (response.status) {
          location.reload(); // Reload the page
        } else {
          Swal.fire("Error", response.message, "error");
        }
      },
      error: (error) => {
        console.error("AJAX Error:", error);
        Swal.fire(
          "Error",
          "An error occurred while updating the cart",
          "error"
        );
      },
    });
  }

  function confirmRemove(productId) {
    Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, remove it!",
    }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: `/deleteItem?id=${productId}`,
          method: "DELETE",
          success: (response) => {
            if (response.status) {
              Swal.fire({icon: "success", title:"Removed!",text:response.message,showConfirmButton: false,timer: 1200} ).then(()=>location.reload());
            } else {
              Swal.fire({icon: "error", title:"Error!",text:response.message,showConfirmButton: false,timer: 1500} )
            }
          },
          error: (error) => {
            console.error("AJAX Error:", error);
            Swal.fire(
              "Error",
              "There was an error removing the item from the cart",
              "error"
            );
          },
        });
      }
    });
  }

  function viewShippingCharge() {
    Swal.fire({
      title: "Shipping Information",
      text: "standard Shipping fee of ₹50 Rupees",
      icon: "info",
      confirmButtonText: "OK",
      confirmButtonColor: "#4d82ea",
    });
  }
</script>

<% include('../partials/alerts.ejs') %> <%-include('../partials/footer.ejs') %>
